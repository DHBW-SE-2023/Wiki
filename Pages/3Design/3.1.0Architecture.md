# Architecture


## 0. Overall Architecture


YAAC uses MVVM as overall architecture. MVVM is short for Model-View-ViewModel which is a design pattern used in software development for building user interfaces. The advantage of mvvm is the separation of concerns between the data, presentation logic, and user interface. This separation makes the codebase easier to understand, maintain, and modify, as changes in one component do not directly impact the others.

The basic structure of mvvm in YAAC is shown in the following diagram:
![Project Connections](/Diagrams/Images/ProjectConnections.png)

The model represent the data and business logic of the application as it contains the data and operations that are independent of the user interface. Models are objects that interact with the database, image processing and email integration to fetch data.

The view is the UI of the application. It displays the data from the ViewModel and sends user input back to the ViewModel for processing.

The ViewModel mediates between the Model and the View. It exposes data and commands from the Model to the View and handles user interactions from the View. ViewModels contain properties that represent the state of the UI and methods or commands to perform actions in response to user input.

The exact implementation is shown here:

![Component Diagram](/Diagrams/Images/ComponentDiagram.png "component diagram")

![Package Diagram](/Diagrams/Images/PackageDiagram.png "package diagram")

## 1. HMI

### 1.1 Choice of Technology

The goal is to develop a cross-platform application which can easily be installed on every common desktop operating system. After trying and demonstrating several promising technology stacks and programming languages in the [Prototyping Branches](https://github.com/DHBW-SE-2023/Prototyping) and documenting our findings in the corresponding issues on the [Project Board](https://github.com/orgs/DHBW-SE-2023/projects/1/) two **full-stack prototypes** were made in [rust with tauri frontend](https://github.com/DHBW-SE-2023/Prototyping/issues/13) and in [GO with fyne frontend](https://github.com/DHBW-SE-2023/Prototyping/issues/14). 

In the final **Sprint Review** of the prototyping phase the team decided for GO with a fyne frontend. The main reasons were that GO was easier to learn with the existing skill-set and that fyne allowed for distribution in a single executable on every operating system. (Which unfortunately in the end did not work as the later added important dependency GOCV could not be statically linked see [Knows Issues](../5Testing/5.5.0KnownIssues.md)).

### 1.2 Synchronization

YAAC checks every 30 minutes whether new emails have arrived. Therefore, the status of the emails is always reasonably up to date. The app continues to run in the background, even if it is not open on the desktop screen.

## 2. Distribution

We use a **Fat Client** as we run everything locally except for the mail integration. Reasons for this are mostly data protection concerns and the ease of use. This was heavily influenced by the fact that as stated in [1. HMI](#1-hmi) the software was supposed to be able to work with only one executable. A possible add-on could be a cloud-based database integration, which would ensure data integrity as the the data will not be stored on one device only but could lead to data protection problems as the product is working with personal data of students.

![deployment diagram](/Diagrams/Images/DeploymentDiagram.png)

## 3. Infrastructure

### 3.1 Operating Systems

As outlined in [1. HMI](#1-hmi) the software was originally intended to run on every common desktop operating system without additional installation steps or dependencies but this did not work due to the GOCV library dependency not being able to link statically and thus needing extensive setup. With GOCV installed and GO configured correctly the application was tested on Windows with WSL2, MacOS and Linux (Distros: Ubuntu and Arch) but this is only feasible in development environments.

To solve the GOCV issues and to make running the final product as easy as possible `Docker` was chosen as an alternative, the image providing the necessary dependencies as well as configuration and abstracting the users operating system. Unfortunately on some Linux distributions additional steps are required to run the docker container UI. Thus the applications docker image is **only supported on Windows with WSL2** (see [Known Issues](../5Testing/5.5.0KnownIssues.md)).

The most likely enduser operating system is Windows as this is the standard in german university administration. Unfortunately additional steps are necessary. To run `Docker` on this platform with the GUI working  **WSL2** is also required. No further software should be necessary to install. WSL2 already has the basic capability build in to run X11-aware applications.

### 3.2 Programming Language

After we tested different programming languages and their compatibility to different frontend tools in the exploration sprints, we decided to use the programming language Go and combine it with the toolkit Fyne. The reasons for that are described in the subdivision [0.0.0 Research Phase](../0Research/0.0.0ResearchPhase.md).

### 3.3 Libraries

### Go Standard Library

The full list of libraries and frameworks used in the project can be viewed in the [go_mod file](https://github.com/DHBW-SE-2023/YAAC/blob/master/go.mod). The most important libraries however are:

- go-imap: a simple library for *SMTP* and *Imap* mail server integration into GO-Projects
- go-sqlite3, sqlite and gorm: libraries enabling the program to set up a sqlite database connection. This database server can be shipped in the same executable and does not require preinstalled software on the users end. Additionally gorm allowes for easy mapping and use of relational database entries to GOs object oriented datatypes (the inclusion of gorm needed a database rewrite but made the code easier to understand and expand)
- gosseract: binding to Tesseract C++ library. Tesseract is a highly accurate open source optical character recognition engine that converts images of text into machine-readable text. YAAC uses Tesseract to extract the text of the image of the attendance list.
- gocv: wrapper for the OpenCV library. OpenCV, short for Open Source Computer Vision Library, is an open source computer vision and machine learning software library. YAAC uses OpenCV for the image processing component.
- fyne: graphical library for the frontend


### 3.4 Frameworks

#### Fyne

Cross-platform UI toolkit for GO using the GTK toolkit. It allows to define the user interface using GO and export the it as native application in a single file including backend and frontend on every desktop and even mobile platform without any other software required on the endusers system. The decision to use fyne is outlined in [0.0.0 Research Phase](../0Research/0.0.0ResearchPhase.md).



### 3.5 Communication Protocols

The email service implementation works via IMAP with and without TLS. This is the only outside communication the application uses which is a strong case for data protection but could in the future be extended with cloud sync capability.

### 3.6 Safety Aspects

Storing the data in a SQLite database on the users device and not syncing it anywhere else protects the students personal data and should to our understanding be GDPR compliant (we did not consult a lawyer so this is not meant as legal advice and we can not be certain of legal implications). On the other hand this does put the data at risk of loss due to hardware failure. The database is not encrypted but stored plainly on the users drive this put the responsibility for the data security on the user. The team decided against a static encryption where the user would have to enter his password every time when starting the application for user comfort. Planned for the future was an encryption using keys stored in the operating systems keyring, unfortunately this was complicated to implement in the corss-plattform environment and was thus not prioritized but should be added in versions to come.


## 4. Data Handling

### 4.1 Database

The user data are saved in a database using SQLight. The reasons for this decision are described in chapter [0.0.0 Research Phase](../0Research/0.0.0ResearchPhase.md). 

### 4.2 Local/Central

The database is saved on the computer locally. An optional feature would be to implement the storage on a cloud as it would be better for data integrity.

### 4.3 Relational Database

The chosen database system is SQLite, which is a relational database.

For faster execution and security against SQL-Injection attacks it is crucial to use prepared statements wherever user input is parsed to an SQL statement. Prepared statements save resources and accept input variables only as values not as part of the sql statement. Their usage is described [here](https://go.dev/doc/database/prepared-statements).

The entity relationship diagram of the database shows a high level overview planned out with everyone involved. It defines all tables (Student, Attendance, AttendanceList), their attributes and their relations needed for the basic program and leaves expandability.

![ERM](https://github.com/DHBW-SE-2023/Wiki/blob/main/Diagrams/Database/DB-Entwurf.png "ERM high level overview of the database")

The data dictionary is described in the following:

### Course

| attribute name | data type |
| ------- | ------ |
| Name: string
| Students: []Student

---

### Student

| attribute name | data type |
| ------- | ------ |
| FirstName        | string required |
| LastName         | string required |
| CourseID         | uint |
| IsImmatriculated | bool |

---

### Attendance

| attribute name | data type |
| ------- | ------ |
| StudentID        | uint primaryKey |
| AttendanceListID | uint primaryKey |
| IsAttending      | bool |
| NameROI          | Rectangle |
| SignatureROI     | Rectangle |
| TotalROI         | Rectangle |

---

### AttendanceList

| attribute name | data type |
| ------- | ------ |
| CreatedAt    | time.Time, primaryKey |
| UpdatedAt    | time.Time |
| CourseID     | uint foreignKey:Id; references:Course |
| ReceivedAt   | time.Time |
| Attendancies | []Attendance |
| Image        | []byte // image as png |

---

### Setting

| attribute name | data type |
| ------- | ------ |
| Setting | string primaryKey |
| Value   | string |



Date is not a known type to sqlite but is can be represented as text in ISO8601 strings ("YYYY-MM-DD HH:MM:SS.SSS"). And build-in functions can produce such strings.


### 4.4 Backup/Replication

There is no backup database in the current project plan for YAAC. The images still would exist in the user's email inbox. The absent students have to be noted on a university owned system, therefore this part of the data would be saved as well. In conclusion a backup would be recommendable, but it's not required, which makes this aspect optional.

