# Building Block View


<font color = red>
Software Baustein

abgeschlossener, binärer Baustein (lib, dll, exe,...)

gruppierte Funktionalität, welche anwendungsorientiert ist, semantisch zusammengehörend ist, über Schnittstellen zugreifbar ist, wiederverwendbar ist

Komponentenbasierte Softwareentwicklung:
- Schnelle, preiswerte Softwareentwicklung
- visuelle Entwicklung mit CASE Tools möglich
- Komponenten werden für den Einsatz ggf. konfiguriert
- Bsp.: Klassenbibliotheken, Web services, Micro services

</font>

YAAC breaks down in three (OR FOUR???) subsystems as presented below. 

<font color = green>
DIAGRAM

</font>

Subsystems:

- Mail Integration: Searches all incoming mails for the keywords in the subject and extracts the images
- Image Processing: Analyzes and processes all extracted images and sends output towards the database
- Database: Stores all output data.
- UI(???)

---

## Mail Integration

### Intent/Responsibility

This subsystem implements the connection with the mail server to intercept the incoming mails amd find the ones relevant to YAAC. The project uses the IMAP protocol. It fetches the incoming mail and checks if the subject includes words like "Liste" (list), "Anwesenheit" (attendance), "Anwesenheitsliste"(attendance list). If that is the case, the attachement of the mail is extracted and sent to the building block image processing.

### Interfaces

### Files

### Open Issues

## Image Processing

### Intend/Responsibility

This subsystem is tasked of extracting the useful information out of an image containing an attendance list.
It finds the attendance list in the image and transforms the image in such a way that the new image only contains the attendance list, showing it from an orthogonal view (See [Perspective Transform](https://en.wikipedia.org/w/index.php?title=3D_projection&oldid=1199861711#Perspective_projection)). 
After finding the attendance list and focusing the image onto the table showing the signatures (from hereon simply refered to by the table) it also has the parsing the table. This means saving the coordinates of the table cells in a virtual table, converting the students' names from an image to text, and validating the signature of each student.

### Interfaces

|**Function**|**Short description**|
|---|---|
|FindTable|Find the table in an image. It warps the image accordingly.|
|PrepareImage|Prepare the image for further use.|
|ParseTable|Parse an image of a table, saving the rows and columns as well as the prepared image.|
|NewTable|Find table, parse it and validate the table[^1].|



|**Method**|**Short description**|
|---|---|
|Review|Review the image of the table, which is expected to be prepared by PrepareImage|

You find details about the Image Processing subsystem in the white box view.

[^1]: These tasks combined into one function, because no part should ever need to execute this "pipeline" on it own, because it might yield a different result than expected.

### Files

The code for this module can be found in `internal/backend/imgproc`.

### Open Issues

- The logic in `FindTable` finds the largest rectangle in an image. For attendance lists printed on white paper and photos taken of it on a white underground is no problem. 
It assumes that the largest rectangle is the table for the signatures.
If the photo is taken on a dark background, the largest rectangle is the attendance sheet and the table can not be parsed correctly.

- The behaviour parsing the table when the image was taken with insufficient lighting was not tested.

## Database

### Intent/Responsibility

The intent of the database subsystem is to provided an abstracted way to access and store persistent data for the application. It holds the connection to the database and manages its tables.
(See also [Data Handling](3.1.0Architecture.md#4-data-handling))

### Interfaces

#### MVVM methods
The methods are part of the MVVM interface.

|**Method**|**Short description**|
|---|---|
|ConnectDatabase|Connect the database backend to the database saved in `data/data.db`.|
|InsertList|Insert a new attendance list.|
|UpdateList|Update the fields of an attendance list.|
|LatestList|Fetch the latest submitted list before a certain date for a course.|
|InsertCourse|Add a new course. No two courses with the same name may exist.|
|Courses|Fetch all courses.|
|AllAttendanceListInRangeByCourse|Fetches all attendance lists in a certain time range for a course.|
|AllAttendanceListInRange|Fetches all attendance lists in a certain time range.|
|Settings|Returns all settings for the application|
|SettingsUpdate|Update the values for a list of settings (which are key-value pairs).|
|SettingsReset|Reset the settings to their default value.|
|InsertStudent|Add a new student.|
|CourseStudents|Fetch all students for a course.|
|CourseByName|Fetch a course by name. Course names are unique.|
|Students|Fetch all students, filter by a predicate.|

#### Module methods are equivalent to the MVVM
The module methods are equivalent to the [MVVM methods](#mvvm-methods) and are therefore omitted here. The only difference is that they are part of the `BackendDatabase` interface instead of the `MVVM` interface.

### Files

The code for this module can be found in `internal/backend/database` and `internal/mvvm/database.go`.

### Open Issues
None