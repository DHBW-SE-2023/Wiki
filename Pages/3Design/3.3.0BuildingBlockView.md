# Building Block View

<!--
Software Baustein

abgeschlossener, binärer Baustein (lib, dll, exe,...)

gruppierte Funktionalität, welche anwendungsorientiert ist, semantisch zusammengehörend ist, über Schnittstellen zugreifbar ist, wiederverwendbar ist

Komponentenbasierte Softwareentwicklung:
- Schnelle, preiswerte Softwareentwicklung
- visuelle Entwicklung mit CASE Tools möglich
- Komponenten werden für den Einsatz ggf. konfiguriert
- Bsp.: Klassenbibliotheken, Web services, Micro services

-->

YAAC breaks down in four subsystems as presented below. 

- Mail Integration: Searches all incoming mails for the keywords in the subject and extracts the images
- [Image Processing](/Pages/3Design/3.4.0ImageProcessing.md): Analyzes and processes all extracted images and sends output towards the database
- Database: Stores all output data from image processing
- Frontend: Contains all frontend functions

---


## 1. Mail Client

### 1.1 Intent/Responsibility

The main task of the Mail module is to retrieve mails from the mail server and analyze them. All unread mails are checked to see whether they are from today's date and have "Anwesenheitsliste" in the subject line. The list is then extracted from the attachment. This data is then returned. It also can check the Connection to the mail server.

### 1.2 Interfaces
The mail client functionality is provided by `MailClient`. This backend fetches and analyzes the mail data and the data in it can only be accessed through the interface provided by the backend.
The interface of the `MailClient` is passed onto the MVVM interface.

The default MVVM implementation inherits its database functionality from `BackendMail`, which is the implementation of `MailClient`.

|**Method**|**Short description**|
|---|---|
|New|Create a new mail backend with the given user login credentials.|
|CheckMailConnection|Checks the mail connection and the user login data|
|GetMailsToday|Fetches all unread mails from today and extracts the binary image data.|

### 1.3 Files

The code for this module can be found in `internal/backend/mail` and `internal/mvvm/mail.go`.

### 1.4 Open Issues

None

## 2. Image Processing

### 2.1 Intend/Responsibility

This subsystem is tasked of extracting the useful information out of an image containing an attendance list.
It finds the attendance list in the image and transforms the image in such a way that the new image only contains the attendance list, showing it from an orthogonal view (See [Perspective Transform](https://en.wikipedia.org/w/index.php?title=3D_projection&oldid=1199861711#Perspective_projection)). 
After finding the attendance list and focusing the image onto the table showing the signatures (from hereon simply referred to by the table) it also has the parsing the table. This means saving the coordinates of the table cells in a virtual table, converting the students' names from an image to text, and validating the signature of each student.

### 2.2 Interfaces

#### MVVM

|**Method**|**Short description**|
|---|---|
|NewTable|Find table, parse it and validate the table. Uses `NewTable` of the module internally.|

#### Module

|**Function**|**Short description**|
|---|---|
|FindTable|Find the table in an image. It warps the image accordingly.|
|PrepareImage|Prepare the image for further use.|
|ParseTable|Parse an image of a table, saving the rows and columns as well as the prepared image.|
|ValidateSignature|Checks whether the signature(s) contained in an image are valid. If more than one is present, it is invalid.|
|NewTable|Find table, parse it and validate the table[^1].|



|**Method (Table)**|**Short description**|
|---|---|
|Review|Review the image of the table, which is expected to be prepared by PrepareImage|

You find details about the Image Processing subsystem in the white box view.

[^1]: These tasks combined into one function, because no part should ever need to execute this "pipeline" on it own, because it might yield a different result than expected.

### 2.3 Files

The code for this module can be found in `internal/backend/imgproc` and `internal/mvvm/imgproc.go`.

### 2.4 Open Issues

- The logic in `FindTable` finds the largest rectangle in an image. For attendance lists printed on white paper and photos taken of it on a white underground is no problem. 
It assumes that the largest rectangle is the table for the signatures.
If the photo is taken on a dark background, the largest rectangle is the attendance sheet and the table can not be parsed correctly.

- The behavior parsing the table when the image was taken with insufficient lighting was not tested.

- Signatures can not be properly validated if the signer does not apply sufficient pressure on the pen.

- Name recognition is not properly working, as it keeps detecting letters that are not there (mostly "." or "|"), though this issue is mitigated by removing those letters.

- Validation, no verification: It is only checked whether a signature is present, the signature is not compared with past signatures to ensure that the signer is the same person.

## 3. Database

### 3.1 Intent/Responsibility

The database's main responsibility of managing persistent data for the application can be broken down into two parts: managing settings and managing everything around attendance lists. Settings, students, course, attendance lists, etc. are saved as tables in a relational database.
See the [data dictionary](3.1.0Architecture.md#4-data-handling) for more information.

### 3.2 Interfaces

The database functionality is provided by `DatabaseClient`. This backend holds the database connection and the data in it can only be accessed through the interface provided by the backend.
The interface of the `DatabaseClient` is passed onto the MVVM interface.

The default MVVM implementation inherits its database functionality from `BackendDatabase`, which is the implementation of `DatabaseClient`.

|**Method**|**Short description**|
|---|---|
|ConnectDatabase|Connect the database, which is conventionally saved in `data/data.db`.|
|InsertList|Insert a new attendance list.|
|UpdateList|Update the fields of an attendance list.|
|LatestList|Fetch the latest submitted list before a certain date for a course.|
|InsertCourse|Add a new course. No two courses with the same name may exist.|
|Courses|Fetch all courses.|
|AllAttendanceListInRangeByCourse|Fetches all attendance lists in a certain time range for a course.|
|AllAttendanceListInRange|Fetches all attendance lists in a certain time range.|
|Settings|Returns all settings for the application|
|SettingsUpdate|Update the values for a list of settings (which are key-value pairs).|
|SettingsReset|Reset the settings to their default value.|
|InsertStudent|Add a new student.|
|CourseStudents|Fetch all students for a course.|
|CourseByName|Fetch a course by name. Course names are unique.|
|Students|Fetch all students, filter by a predicate.|


### 3.3 Files

The code for this module can be found in `internal/backend/database` and `internal/mvvm/database.go`.

### 3.4 Open Issues

None

## 4.Frontend

### 4.1 Intent/Responsibility

The frontend enables the user to access the data provided and to change it if necessary. It prepares the data and functionalities in a clear and well structured user interface.

### 4.2 Interfaces

The interface of the Frontend is passed onto the MVVM interface.

### 4.3 Files

The code for this modules can be found in `internal/frontend` and `internal/mvvm/frontend.go`.

### 4.4 Open Issues

None